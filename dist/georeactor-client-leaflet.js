/*
 GeoReactor-Client 0.1.1+470b123  http://georeactor.com
 (c) 2016 Nicholas Doiron (under open source, MIT license)
*/
!function(t,e,o){"undefined"==typeof console&&(console={log:function(){},error:function(){}}),Array.prototype.forEach||(Array.prototype.forEach=function(t,e){var o,n;for(o=0,n=this.length;o<n;++o)o in this&&t.call(e,this[o],o,this)}),"map"in Array.prototype||(Array.prototype.map=function(t,e){for(var o=new Array(this.length),n=0,a=this.length;n<a;n++)n in this&&(o[n]=t.call(e,this[n],n,this));return o}),(t||global).georeactor=function(){console.error("GEOREACTOR: no maps library was added")},(t||global).GEOREACTOR={data:[],options:{},valuesForField:{},_:{}},function(){function t(t,n){var a=t,r=new XMLHttpRequest;r.open("GET",t,!0),r.onreadystatechange=function(){if(4===this.readyState)if(this.status>=200&&this.status<400){var t=null,r=a.toLowerCase();if(r.indexOf("topojson")>-1||r.indexOf("topo.json")>-1){var i=JSON.parse(this.responseText),s=Object.keys(i.objects)[0];t=topojson.feature(i,i.objects[s])}else{if(!(r.indexOf("geojson")>-1||r.indexOf("geo.json")>-1))throw"data type unknown: "+r;t=JSON.parse(this.responseText)}t.features.map(function(t){var n=Object.keys(t.properties);n.map(function(e){var o=t.properties[e];GEOREACTOR.valuesForField[e]||(GEOREACTOR.valuesForField[e]={min:o,max:o,nonZeroCount:0}),o<GEOREACTOR.valuesForField[e].min&&(GEOREACTOR.valuesForField[e].min=o),o>GEOREACTOR.valuesForField[e].max&&(GEOREACTOR.valuesForField[e].max=o),o&&GEOREACTOR.valuesForField[e].nonZeroCount++});var a=e(t.geometry.coordinates);t.properties.bounds=a,o?(o[0]=Math.min(o[0],a[0]),o[1]=Math.min(o[1],a[1]),o[2]=Math.max(o[2],a[2]),o[3]=Math.max(o[3],a[3])):o=a}),GEOREACTOR._.fitBounds(o),n(t)}else console.log("failed to do XMLHttpRequest")},r.send()}function e(t,o){if(o||(o=[180,90,-180,-90]),"number"==typeof t[0])o[0]=Math.min(o[0],t[0]),o[1]=Math.min(o[1],t[1]),o[2]=Math.max(o[2],t[0]),o[3]=Math.max(o[3],t[1]);else for(var n=0;n<t.length;n++)o=e(t[n],o);return o}var o;GEOREACTOR.parseAttribute=function(t,e){var o=t+"",n=(e||"")+"",a=function(t){return t.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&")};if(GEOREACTOR.options&&GEOREACTOR.options.attributes){var r=GEOREACTOR.options.attributes[o];if(r===!1)return!1;if("undefined"!=typeof r&&null!==r)if("function"==typeof r.label?o=r.label(t,e,GEOREACTOR.selectFeature):"string"==typeof r.label&&(o=r.label),"function"==typeof r.value)n=r.value(t,e,GEOREACTOR.selectFeature);else if("string"==typeof r.value){var i=new RegExp("#\\{"+a(t)+"\\}","g");n=r.value.replace(i,n)}}return"object"==typeof n&&(n=JSON.stringify(n)),[o,n]},GEOREACTOR.sortPropKeys=function(t){return GEOREACTOR.options.attributes&&GEOREACTOR.options.attributes._order&&t.sort(function(t,e){var o=GEOREACTOR.options.attributes._order.indexOf(t.label),n=GEOREACTOR.options.attributes._order.indexOf(e.label);if(o!==n){if(o===-1)return 1;if(n===-1)return-1}return o-n}),t},GEOREACTOR.commonDataLoader=function(){0===GEOREACTOR.options.data.length&&console.log("GEOREACTOR: no datasets to load"),GEOREACTOR.options.data.map(function(e){t(e,function(t){GEOREACTOR._.mapJSONfile(t)})})}}(),function(){if("undefined"==typeof GEOREACTOR)return void console.error("GEOREACTOR: georeactor-client.js must be loaded for georeactor-leaflet to work");GEOREACTOR.library="leaflet";var t,o;GEOREACTOR._.mapJSONfile=function(e){return dataLayer=L.geoJson(e,{style:function(t){return{fillColor:"#f00",fillOpacity:0,color:"#444",weight:2}},onEachFeature:function(e,n){if(GEOREACTOR.options.popups){var a=["bounds"],r=Object.keys(e.properties),i="<table>";GEOREACTOR.sortPropKeys(r),r.map(function(t){if(!(a.indexOf(t)>-1)){var o=GEOREACTOR.parseAttribute(t,e.properties[t]);o!==!1&&(i+="<tr><td>"+o[0]+"</td><td>"+o[1]+"</td></tr>")}}),i+="</table>",n.bindPopup(i)}n.on("click",function(){if("function"==typeof GEOREACTOR.initReact&&GEOREACTOR.initReact(),o&&t.removeLayer(o),"Point"===e.geometry.type){var n=e.geometry.coordinates.concat([]);n.reverse(),o=L.circleMarker(n,{radius:80,strokeColor:"#f00",fillColor:"#f00"}).addTo(t)}GEOREACTOR._.fitBounds(e.properties.bounds),GEOREACTOR.selectFeature=e,GEOREACTOR._.detailView&&GEOREACTOR._.detailView.setState({selectFeature:e}),dataLayer.setStyle(function(t){var o=0;return e===t&&(o=.2),{fillColor:"#f00",fillOpacity:o,color:"#444",weight:1}})})}}).addTo(t),dataLayer},georeactor=function(o){if(GEOREACTOR.options=o,t=L.map(o.div||"map").setView([o.lat||0,o.lng||o.lon||0],o.zoom||5),t.attributionControl.setPrefix(""),"function"==typeof L.Hash&&new L.Hash(t),GEOREACTOR.options.tiles&&GEOREACTOR.options.tiles.length)if("string"==typeof GEOREACTOR.options.tiles)L.tileLayer(GEOREACTOR.options.tiles,{maxZoom:17}).addTo(t);else{var n={};GEOREACTOR.options.tiles.forEach(function(e,o){e=L.tileLayer(e,{maxZoom:17}).addTo(t),n["ABCDEFGHIJKLMNOPQRSTUVWXYZ"[o]]=e}),L.control.layers(n,{}).addTo(t)}else{var a=L.tileLayer("//tile-{s}.openstreetmap.fr/hot/{z}/{x}/{y}.png",{attribution:"Map data &copy; OpenStreetMap contributors",maxZoom:17}).addTo(t),r=L.tileLayer("//{s}.tiles.mapbox.com/v3/mapmeld.map-a6ineq7y/{z}/{x}/{y}.png?updated=65f7243",{attribution:"Map data &copy; OpenStreetMap contributors; satellite from MapBox",maxZoom:17});L.control.layers({OpenStreetMap:a,Satellite:r},{}).addTo(t),t.on("baselayerchange",function(){})}var i=e.getElementsByClassName("leaflet-control-layers-toggle");i.length&&setTimeout(function(){i[0].style.backgroundImage="url(styles/lib/images/layers.png)"},200),GEOREACTOR._.fitBounds=function(e){t.fitBounds(L.latLngBounds(L.latLng(e[1],e[0]),L.latLng(e[3],e[2])))},GEOREACTOR.commonDataLoader(),"function"==typeof GEOREACTOR.initReact&&GEOREACTOR.initReact()}}()}(window,document);